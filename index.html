<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO Annotator - FabLab TecMedHub</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="yolo-annotator.css">
    
    <!-- External Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header" data-intro="Bienvenido al Anotador YOLO" data-step="1">
            <div class="header-content">
                <div class="header-left">
                    <div>
                        <h1 class="app-title"><i class="fas fa-tag"></i> YOLO Annotator</h1>
                        <p class="app-subtitle">Herramienta profesional de anotación</p>
                    </div>
                </div>
                
                <div class="header-branding">
                    <i class="fas fa-flask"></i>
                    <div>
                        <strong>FabLab TecMedHub</strong><br>
                        <small>Universidad Austral de Chile - Sede Puerto Montt</small>
                    </div>
                </div>
                
                <div class="header-right">
                    <select id="projectSelector" class="project-selector" data-intro="Selecciona o crea un proyecto aquí" data-step="2">
                        <option value="">Seleccionar proyecto...</option>
                    </select>
                    
                    <button class="btn-header" id="btnNewProject" title="Nuevo Proyecto">
                        <i class="fas fa-plus"></i> Nuevo
                    </button>
                    
                    <button class="btn-header" id="btnExportProject" title="Exportar Proyecto Completo">
                        <i class="fas fa-file-export"></i>
                    </button>
                    
                    <button class="btn-header" id="btnExportConfig" title="Exportar Configuración">
                        <i class="fas fa-cog"></i>
                    </button>
                    
                    <button class="btn-header" id="btnImportConfig" title="Importar Configuración">
                        <i class="fas fa-file-import"></i>
                    </button>
                    
                    <button class="btn-header" id="btnHelp" title="Ayuda">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Sidebar -->
            <aside class="sidebar" data-intro="Herramientas de anotación y configuración" data-step="3">
                <!-- Tools Section -->
                <div class="panel-section">
                    <h3><i class="fas fa-tools"></i> Herramientas</h3>
                    <div class="tool-selector">
                        <div class="tool-btn active" data-tool="bbox" title="Bounding Box (B)">
                            <i class="fas fa-vector-square"></i>
                            <span>Box</span>
                        </div>
                        <div class="tool-btn" data-tool="mask" title="Máscara (M)">
                            <i class="fas fa-paint-brush"></i>
                            <span>Mask</span>
                        </div>
                        <div class="tool-btn" data-tool="select" title="Seleccionar (V)">
                            <i class="fas fa-mouse-pointer"></i>
                            <span>Select</span>
                        </div>
                        <div class="tool-btn" data-tool="pan" title="Pan (H)">
                            <i class="fas fa-hand-paper"></i>
                            <span>Pan</span>
                        </div>
                    </div>
                </div>

                <!-- Classes Section -->
                <div class="panel-section" data-intro="Gestiona las clases de tu proyecto" data-step="4">
                    <h3><i class="fas fa-tags"></i> Clases Activas</h3>
                    <div class="class-list" id="classList">
                        <div class="empty-message">Crea un proyecto primero</div>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="panel-section">
                    <h3><i class="fas fa-image"></i> Cargar Imagen</h3>
                    <div class="file-upload">
                        <input type="file" id="imageInput" accept="image/*" multiple>
                        <label for="imageInput" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span>Seleccionar imágenes</span>
                        </label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="panel-section">
                    <h3><i class="fas fa-bolt"></i> Acciones</h3>
                    <div class="btn-group">
                        <button class="btn btn-info btn-block" id="btnSave" disabled title="Guardar (Ctrl+S)">
                            <i class="fas fa-save"></i> Guardar
                        </button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-warning btn-block" id="btnUndo" title="Deshacer (Ctrl+Z)">
                            <i class="fas fa-undo"></i> Deshacer
                        </button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-danger btn-block" id="btnClear" title="Limpiar">
                            <i class="fas fa-trash"></i> Limpiar
                        </button>
                    </div>
                </div>

                <!-- Keyboard Shortcuts -->
                <div class="panel-section">
                    <h3><i class="fas fa-keyboard"></i> Atajos</h3>
                    <div class="shortcuts-list">
                        <div class="shortcut-item">
                            <span>Guardar</span>
                            <span class="shortcut-key">Ctrl+S</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Deshacer</span>
                            <span class="shortcut-key">Ctrl+Z</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Eliminar</span>
                            <span class="shortcut-key">Del</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Navegación</span>
                            <span class="shortcut-key">← →</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Bbox</span>
                            <span class="shortcut-key">B</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Mask</span>
                            <span class="shortcut-key">M</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Select</span>
                            <span class="shortcut-key">V</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Pan</span>
                            <span class="shortcut-key">H</span>
                        </div>
                        <div class="shortcut-item">
                            <span>Clase 1-9</span>
                            <span class="shortcut-key">1-9</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Canvas Area -->
            <main class="canvas-container" data-intro="Área de trabajo principal. Dibuja tus anotaciones aquí" data-step="5">
                <canvas id="canvas" width="1200" height="800"></canvas>
                
                <!-- Image Info -->
                <div class="image-info" id="imageInfo" style="display: none;">
                    <div class="image-info-item">
                        <i class="fas fa-image"></i>
                        <span class="image-info-value" id="imageName">-</span>
                    </div>
                    <div class="image-info-item">
                        <i class="fas fa-ruler-combined"></i>
                        <span class="image-info-value" id="imageDimensions">-</span>
                    </div>
                    <div class="image-info-item">
                        <i class="fas fa-tags"></i>
                        <span class="image-info-value" id="annotationCount">0</span>
                    </div>
                </div>

                <!-- Canvas Controls -->
                <div class="canvas-controls">
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <div class="control-group">
                        <button class="control-btn" id="btnZoomIn" title="Zoom In">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="control-btn" id="btnZoomOut" title="Zoom Out">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="control-btn" id="btnZoomReset" title="Reset Zoom">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="control-group">
                        <button class="control-btn" id="btnToggleLabels" title="Mostrar/Ocultar Etiquetas">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="control-btn" id="btnToggleGrid" title="Mostrar/Ocultar Grilla">
                            <i class="fas fa-th"></i>
                        </button>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="image-navigation">
                    <button class="nav-btn" id="btnPrevImage" disabled title="Imagen Anterior (←)">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn" id="btnNextImage" disabled title="Imagen Siguiente (→)">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </main>

            <!-- Right Panel -->
            <aside class="right-panel" data-intro="Panel de gestión: clases, galería y estadísticas" data-step="6">
                <!-- Project Stats -->
                <div class="panel-section">
                    <h3><i class="fas fa-chart-bar"></i> Estadísticas</h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalImages">0</div>
                            <div class="stat-label">Imágenes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAnnotated">0</div>
                            <div class="stat-label">Anotadas</div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statLabels">0</div>
                            <div class="stat-label">Etiquetas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statClasses">0</div>
                            <div class="stat-label">Clases</div>
                        </div>
                    </div>
                    
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">0/0 imágenes anotadas</div>
                    </div>
                </div>

                <!-- Class Manager -->
                <div class="panel-section">
                    <h3><i class="fas fa-palette"></i> Gestionar Clases</h3>
                    <div class="class-manager">
                        <div class="class-input-group">
                            <input type="text" id="newClassName" class="class-input" placeholder="Nombre de clase">
                            <input type="color" id="newClassColor" class="color-input" value="#e74c3c">
                        </div>
                        <button class="btn btn-primary btn-block" id="btnAddClass">
                            <i class="fas fa-plus"></i> Agregar Clase
                        </button>
                    </div>
                </div>

                <!-- Gallery -->
                <div class="panel-section">
                    <h3><i class="fas fa-images"></i> Galería</h3>
                    <div class="gallery-filters">
                        <button class="filter-btn active" data-filter="all">Todas</button>
                        <button class="filter-btn" data-filter="annotated">Anotadas</button>
                        <button class="filter-btn" data-filter="unannotated">Sin anotar</button>
                    </div>
                    <div class="gallery-container">
                        <div class="gallery-grid" id="galleryGrid">
                            <div class="empty-gallery">No hay imágenes</div>
                        </div>
                    </div>
                </div>

                <!-- Export -->
                <div class="panel-section">
                    <h3><i class="fas fa-download"></i> Exportar</h3>
                    <button class="btn btn-success btn-block" id="btnDownloadZip" disabled>
                        <i class="fas fa-file-archive"></i> Descargar Dataset ZIP
                    </button>
                    <button class="btn btn-outline btn-block" id="btnDownloadClasses" style="margin-top: 8px;">
                        <i class="fas fa-file-alt"></i> Descargar classes.txt
                    </button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Custom JavaScript -->
    <script src="yolo-annotator.js"></script>
    
    <!-- Initialize Tour -->
    <script>
        // Tour configuration
        function startAppTour() {
            const intro = introJs();
            intro.setOptions({
                steps: [
                    {
                        element: document.querySelector('[data-step="1"]'),
                        intro: "Bienvenido al <strong>YOLO Annotator</strong>. Esta herramienta te permite anotar imágenes para entrenar modelos YOLO.",
                        position: 'bottom'
                    },
                    {
                        element: document.querySelector('[data-step="2"]'),
                        intro: "Primero, crea un nuevo proyecto o selecciona uno existente. Cada proyecto puede ser de tipo <strong>Bounding Box</strong> o <strong>Segmentación</strong>.",
                        position: 'bottom'
                    },
                    {
                        element: document.querySelector('[data-step="3"]'),
                        intro: "Aquí encontrarás las <strong>herramientas</strong> de anotación: Box para rectángulos, Mask para máscaras pintables, Select para editar, y Pan para mover la vista.",
                        position: 'right'
                    },
                    {
                        element: document.querySelector('[data-step="4"]'),
                        intro: "Define tus <strong>clases</strong> de anotación. Cada clase tiene un nombre y un color. Puedes agregar, editar o eliminar clases.",
                        position: 'right'
                    },
                    {
                        element: document.querySelector('[data-step="5"]'),
                        intro: "El <strong>área de trabajo</strong> principal. Aquí cargarás tus imágenes y crearás las anotaciones. Usa el mouse para dibujar y la rueda para hacer zoom.",
                        position: 'left'
                    },
                    {
                        element: document.querySelector('[data-step="6"]'),
                        intro: "Panel de gestión donde verás las <strong>estadísticas</strong> del proyecto, la <strong>galería</strong> de imágenes y podrás <strong>exportar</strong> tu dataset en formato YOLO.",
                        position: 'left'
                    }
                ],
                nextLabel: 'Siguiente →',
                prevLabel: '← Anterior',
                doneLabel: '¡Listo!',
                skipLabel: 'Saltar',
                showProgress: true,
                showBullets: false,
                exitOnOverlayClick: false,
                disableInteraction: true
            });
            
            intro.start();
        }
        
        // Add tour to help button
        document.addEventListener('DOMContentLoaded', () => {
            const helpBtn = document.getElementById('btnHelp');
            if (helpBtn) {
                helpBtn.addEventListener('click', startAppTour);
            }
        });
    </script>

    <!-- Additional helper functions -->
    <script>
        // Update button states based on current state
        function updateUIState() {
            if (window.app && window.app.canvasManager) {
                const hasImage = window.app.canvasManager.image !== null;
                const hasAnnotations = window.app.canvasManager.annotations.length > 0;
                const hasProject = window.app.projectManager.currentProject !== null;
                
                // Update button states
                document.getElementById('btnSave').disabled = !hasImage || !hasAnnotations || !hasProject;
                document.getElementById('btnUndo').disabled = !hasAnnotations;
                document.getElementById('btnClear').disabled = !hasAnnotations;
                
                // Update image info
                if (hasImage) {
                    document.getElementById('imageInfo').style.display = 'block';
                    document.getElementById('imageName').textContent = window.app.canvasManager.imageName || 'Sin nombre';
                    document.getElementById('imageDimensions').textContent = 
                        `${window.app.canvasManager.image.width}x${window.app.canvasManager.image.height}`;
                    document.getElementById('annotationCount').textContent = hasAnnotations ? 
                        window.app.canvasManager.annotations.length : 0;
                } else {
                    document.getElementById('imageInfo').style.display = 'none';
                }
                
                // Update stat classes
                if (hasProject && window.app.canvasManager.classes) {
                    document.getElementById('statClasses').textContent = window.app.canvasManager.classes.length;
                }
            }
        }
        
        // Poll for UI updates
        setInterval(updateUIState, 500);
        
        // Download classes.txt
        document.getElementById('btnDownloadClasses')?.addEventListener('click', () => {
            if (window.app && window.app.canvasManager.classes.length > 0) {
                const sortedClasses = [...window.app.canvasManager.classes].sort((a, b) => a.id - b.id);
                const classesContent = sortedClasses.map(cls => cls.name).join('\n');
                
                const blob = new Blob([classesContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'classes.txt';
                a.click();
                URL.revokeObjectURL(url);
                
                window.app.ui.showToast('classes.txt descargado', 'success');
            } else {
                window.app.ui.showToast('No hay clases para descargar', 'warning');
            }
        });
        
        // Undo button
        document.getElementById('btnUndo')?.addEventListener('click', () => {
            if (window.app) {
                window.app.undo();
            }
        });
        
        // Clear button
        document.getElementById('btnClear')?.addEventListener('click', () => {
            if (window.app && confirm('¿Limpiar todas las anotaciones de esta imagen?')) {
                window.app.canvasManager.annotations = [];
                window.app.canvasManager.redraw();
            }
        });
    </script>
</body>
</html>
