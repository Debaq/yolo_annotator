<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YOLO Annotator - FabLab TecMedHub</title>

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/introjs.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="yolo-annotator.css">

    <!-- External Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intro.js/7.2.0/intro.min.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <div>
                        <h1 class="app-title"><i class="fas fa-tag"></i> <span data-i18n="app.title">YOLO Annotator</span></h1>
                        <p class="app-subtitle" data-i18n="app.subtitle">Herramienta profesional de anotación</p>
                    </div>
                </div>

                <div class="header-branding">
                    <i class="fas fa-flask"></i>
                    <div>
                        <strong data-i18n="app.branding.fablab">FabLab TecMedHub</strong><br>
                        <small data-i18n="app.branding.university">Universidad Austral de Chile - Sede Puerto Montt</small>
                    </div>
                </div>

                <div class="header-right">
                    <select id="projectSelector" class="project-selector">
                        <option value="" data-i18n="header.selectProject">Seleccionar proyecto...</option>
                    </select>

                    <button class="btn-header" id="btnNewProject" data-i18n-title="header.newProject">
                        <i class="fas fa-plus"></i> <span data-i18n="header.newProject">Nuevo</span>
                    </button>

                    <button class="btn-header" id="btnExportProject" data-i18n-title="header.exportProject">
                        <i class="fas fa-file-export"></i>
                    </button>

                    <button class="btn-header" id="btnExportConfig" data-i18n-title="header.exportConfig">
                        <i class="fas fa-cog"></i>
                    </button>

                    <button class="btn-header" id="btnImportConfig" data-i18n-title="header.importConfig">
                        <i class="fas fa-file-import"></i>
                    </button>

                    <!-- Language Selector (will be injected here) -->
                    <div id="languageSelectorContainer"></div>

                    <button class="btn-header" id="btnHelp" data-i18n-title="header.help">
                        <i class="fas fa-question-circle"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- Left Sidebar -->
            <aside class="sidebar">
                <!-- Tools Section -->
                <div class="panel-section">
                    <h3><i class="fas fa-tools"></i> <span data-i18n="tools.title">Herramientas</span></h3>
                    <div class="tool-selector">
                        <div class="tool-btn active" data-tool="bbox" data-i18n-title="tools.tooltips.bbox">
                            <i class="fas fa-vector-square"></i>
                            <span data-i18n="tools.bbox">Box</span>
                        </div>
                        <div class="tool-btn" data-tool="mask" data-i18n-title="tools.tooltips.mask">
                            <i class="fas fa-paint-brush"></i>
                            <span data-i18n="tools.mask">Mask</span>
                        </div>
                        <div class="tool-btn" data-tool="select" data-i18n-title="tools.tooltips.select">
                            <i class="fas fa-mouse-pointer"></i>
                            <span data-i18n="tools.select">Select</span>
                        </div>
                        <div class="tool-btn" data-tool="pan" data-i18n-title="tools.tooltips.pan">
                            <i class="fas fa-hand-paper"></i>
                            <span data-i18n="tools.pan">Pan</span>
                        </div>
                    </div>
                </div>

                <!-- Classes Section -->
                <div class="panel-section">
                    <h3><i class="fas fa-tags"></i> <span data-i18n="classes.title">Clases Activas</span></h3>
                    <div class="class-list" id="classList">
                        <div class="empty-message" data-i18n="classes.empty">Crea un proyecto primero</div>
                    </div>
                </div>

                <!-- Image Upload -->
                <div class="panel-section">
                    <h3><i class="fas fa-image"></i> <span data-i18n="images.title">Cargar Imagen</span></h3>
                    <div class="file-upload">
                        <input type="file" id="imageInput" accept="image/*" multiple>
                        <label for="imageInput" class="file-upload-label">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span data-i18n="images.select">Seleccionar imágenes</span>
                        </label>
                    </div>
                </div>

                <!-- Actions -->
                <div class="panel-section">
                    <h3><i class="fas fa-bolt"></i> <span data-i18n="actions.title">Acciones</span></h3>
                    <div class="btn-group">
                        <button class="btn btn-info btn-block" id="btnSave" disabled data-i18n-title="shortcuts.save">
                            <i class="fas fa-save"></i> <span data-i18n="actions.save">Guardar</span>
                        </button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-warning btn-block" id="btnUndo" data-i18n-title="shortcuts.undo">
                            <i class="fas fa-undo"></i> <span data-i18n="actions.undo">Deshacer</span>
                        </button>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-danger btn-block" id="btnClear">
                            <i class="fas fa-trash"></i> <span data-i18n="actions.clear">Limpiar</span>
                        </button>
                    </div>
                </div>

                <!-- Keyboard Shortcuts -->
                <div class="panel-section">
                    <h3><i class="fas fa-keyboard"></i> <span data-i18n="shortcuts.title">Atajos</span></h3>
                    <div class="shortcuts-list">
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.save">Guardar</span>
                            <span class="shortcut-key">Ctrl+S</span>
                        </div>
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.undo">Deshacer</span>
                            <span class="shortcut-key">Ctrl+Z</span>
                        </div>
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.delete">Eliminar</span>
                            <span class="shortcut-key">Del</span>
                        </div>
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.navigation">Navegación</span>
                            <span class="shortcut-key">← →</span>
                        </div>
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.bbox">Bbox</span>
                            <span class="shortcut-key">B</span>
                        </div>
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.mask">Mask</span>
                            <span class="shortcut-key">M</span>
                        </div>
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.select">Select</span>
                            <span class="shortcut-key">V</span>
                        </div>
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.pan">Pan</span>
                            <span class="shortcut-key">H</span>
                        </div>
                        <div class="shortcut-item">
                            <span data-i18n="shortcuts.classes">Clase 1-9</span>
                            <span class="shortcut-key">1-9</span>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Canvas Area -->
            <main class="canvas-container">
                <canvas id="canvas" width="1200" height="800"></canvas>

                <!-- Image Info -->
                <div class="image-info" id="imageInfo" style="display: none;">
                    <div class="image-info-item">
                        <i class="fas fa-image"></i>
                        <span class="image-info-value" id="imageName" data-i18n="imageInfo.noName">-</span>
                    </div>
                    <div class="image-info-item">
                        <i class="fas fa-ruler-combined"></i>
                        <span class="image-info-value" id="imageDimensions">-</span>
                    </div>
                    <div class="image-info-item">
                        <i class="fas fa-tags"></i>
                        <span class="image-info-value" id="annotationCount">0</span>
                    </div>
                </div>

                <!-- Canvas Controls -->
                <div class="canvas-controls">
                    <div class="zoom-level" id="zoomLevel">100%</div>
                    <div class="control-group">
                        <button class="control-btn" id="btnZoomIn" data-i18n-title="canvas.zoomIn">
                            <i class="fas fa-search-plus"></i>
                        </button>
                        <button class="control-btn" id="btnZoomOut" data-i18n-title="canvas.zoomOut">
                            <i class="fas fa-search-minus"></i>
                        </button>
                        <button class="control-btn" id="btnZoomReset" data-i18n-title="canvas.resetZoom">
                            <i class="fas fa-expand"></i>
                        </button>
                    </div>
                    <div class="control-group">
                        <button class="control-btn" id="btnToggleLabels" data-i18n-title="canvas.toggleLabels">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="control-btn" id="btnToggleGrid" data-i18n-title="canvas.toggleGrid">
                            <i class="fas fa-th"></i>
                        </button>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="image-navigation">
                    <button class="nav-btn" id="btnPrevImage" disabled data-i18n-title="canvas.prevImage">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="nav-btn" id="btnNextImage" disabled data-i18n-title="canvas.nextImage">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </main>

            <!-- Right Panel -->
            <aside class="right-panel">
                <!-- Project Stats -->
                <div class="panel-section">
                    <h3><i class="fas fa-chart-bar"></i> <span data-i18n="stats.title">Estadísticas</span></h3>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statTotalImages">0</div>
                            <div class="stat-label" data-i18n="stats.images">Imágenes</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statAnnotated">0</div>
                            <div class="stat-label" data-i18n="stats.annotated">Anotadas</div>
                        </div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="statLabels">0</div>
                            <div class="stat-label" data-i18n="stats.labels">Etiquetas</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="statClasses">0</div>
                            <div class="stat-label" data-i18n="stats.classes">Clases</div>
                        </div>
                    </div>

                    <div class="progress-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-text" id="progressText">
                            <span id="progressCount">0/0</span> <span data-i18n="stats.progress">imágenes anotadas</span>
                        </div>
                    </div>
                </div>

                <!-- Class Manager -->
                <div class="panel-section">
                    <h3><i class="fas fa-palette"></i> <span data-i18n="classes.manage">Gestionar Clases</span></h3>
                    <div class="class-manager">
                        <div class="class-input-group">
                            <input type="text" id="newClassName" class="class-input" data-i18n="classes.placeholder" placeholder="Nombre de clase">
                            <input type="color" id="newClassColor" class="color-input" value="#e74c3c">
                        </div>
                        <button class="btn btn-primary btn-block" id="btnAddClass">
                            <i class="fas fa-plus"></i> <span data-i18n="classes.add">Agregar Clase</span>
                        </button>
                    </div>
                </div>

                <!-- Gallery -->
                <div class="panel-section">
                    <h3><i class="fas fa-images"></i> <span data-i18n="gallery.title">Galería</span></h3>
                    <div class="gallery-filters">
                        <button class="filter-btn active" data-filter="all" data-i18n="gallery.all">Todas</button>
                        <button class="filter-btn" data-filter="annotated" data-i18n="gallery.annotated">Anotadas</button>
                        <button class="filter-btn" data-filter="unannotated" data-i18n="gallery.unannotated">Sin anotar</button>
                    </div>
                    <div class="gallery-container">
                        <div class="gallery-grid" id="galleryGrid">
                            <div class="empty-gallery" data-i18n="gallery.empty">No hay imágenes</div>
                        </div>
                    </div>
                </div>

                <!-- Export -->
                <div class="panel-section">
                    <h3><i class="fas fa-download"></i> <span data-i18n="export.title">Exportar</span></h3>
                    <button class="btn btn-success btn-block" id="btnDownloadZip" disabled>
                        <i class="fas fa-file-archive"></i> <span data-i18n="export.downloadDataset">Descargar Dataset ZIP</span>
                    </button>
                    <button class="btn btn-outline btn-block" id="btnDownloadClasses" style="margin-top: 8px;">
                        <i class="fas fa-file-alt"></i> <span data-i18n="export.downloadClasses">Descargar classes.txt</span>
                    </button>
                </div>
            </aside>
        </div>
    </div>

    <!-- Load i18n FIRST -->
    <script src="i18n.js"></script>

    <!-- Custom JavaScript -->
    <script src="yolo-annotator.js"></script>

    <!-- Initialize Tour and additional features -->
    <script>
        // Wait for i18n to load
        window.addEventListener('DOMContentLoaded', async () => {
            // Wait a bit for i18n to initialize
            await new Promise(resolve => setTimeout(resolve, 100));

            // Inject language selector
            const container = document.getElementById('languageSelectorContainer');
            if (container && window.i18n) {
                const selector = window.i18n.createLanguageSelector();
                container.appendChild(selector);
            }

            // Tour configuration with i18n
            window.startAppTour = function() {
                if (!window.i18n || !window.i18n.translations) {
                    console.error('i18n not loaded');
                    return;
                }

                const intro = introJs();
                intro.setOptions({
                    steps: [
                        {
                            intro: window.i18n.t('tour.welcome')
                        },
                        {
                            element: document.querySelector('#projectSelector'),
                            intro: window.i18n.t('tour.project'),
                            position: 'bottom'
                        },
                        {
                            element: document.querySelector('.sidebar'),
                            intro: window.i18n.t('tour.tools'),
                            position: 'right'
                        },
                        {
                            element: document.querySelector('#classList').parentElement,
                            intro: window.i18n.t('tour.classes'),
                            position: 'right'
                        },
                        {
                            element: document.querySelector('.canvas-container'),
                            intro: window.i18n.t('tour.workspace'),
                            position: 'left'
                        },
                        {
                            element: document.querySelector('.right-panel'),
                            intro: window.i18n.t('tour.management'),
                            position: 'left'
                        }
                    ],
                    nextLabel: window.i18n.t('tour.next'),
                    prevLabel: window.i18n.t('tour.prev'),
                    doneLabel: window.i18n.t('tour.done'),
                    skipLabel: window.i18n.t('tour.skip'),
                    showProgress: true,
                    showBullets: false,
                    exitOnOverlayClick: false,
                    disableInteraction: true
                });

                intro.start();
            };

            // Add tour to help button
            const helpBtn = document.getElementById('btnHelp');
            if (helpBtn) {
                helpBtn.addEventListener('click', window.startAppTour);
            }

            // Listen for language changes to update tour
            window.addEventListener('languageChanged', () => {
                // Tour will use updated translations when started
            });
        });

        // Update button states based on current state
function updateUIState() {
    if (window.app && window.app.canvasManager) {
        const hasImage = window.app.canvasManager.image !== null;
        const hasAnnotations = window.app.canvasManager.annotations.length > 0;
        const hasProject = window.app.projectManager.currentProject !== null;

        // Update button states - con verificación de existencia
        const btnSave = document.getElementById('btnSave');
        const btnUndo = document.getElementById('btnUndo');
        const btnClear = document.getElementById('btnClear');
        const btnDownloadZip = document.getElementById('btnDownloadZip');

        if (btnSave) btnSave.disabled = !hasImage || !hasAnnotations || !hasProject;
        if (btnUndo) btnUndo.disabled = !hasAnnotations;
        if (btnClear) btnClear.disabled = !hasAnnotations;
        if (btnDownloadZip) btnDownloadZip.disabled = !hasProject;

        // Update image info
        const imageInfo = document.getElementById('imageInfo');
        if (imageInfo) {
            if (hasImage) {
                imageInfo.style.display = 'block';
                const nameElement = document.getElementById('imageName');
                const dimensionsElement = document.getElementById('imageDimensions');
                const countElement = document.getElementById('annotationCount');

                if (nameElement) {
                    nameElement.textContent = window.app.canvasManager.imageName ||
                        (window.i18n ? window.i18n.t('imageInfo.noName') : 'No name');
                }
                if (dimensionsElement) {
                    dimensionsElement.textContent =
                        `${window.app.canvasManager.image.width}x${window.app.canvasManager.image.height}`;
                }
                if (countElement) {
                    countElement.textContent = hasAnnotations ?
                        window.app.canvasManager.annotations.length : 0;
                }
            } else {
                imageInfo.style.display = 'none';
            }
        }

        // Update stat classes
        if (hasProject && window.app.canvasManager.classes) {
            const statClasses = document.getElementById('statClasses');
            if (statClasses) {
                statClasses.textContent = window.app.canvasManager.classes.length;
            }
        }

        // Update progress text
        const images = window.app.galleryManager.images;
        const annotated = images.filter(img => img.annotations && img.annotations.length > 0).length;
        const progressCount = document.getElementById('progressCount');
        if (progressCount) {
            progressCount.textContent = `${annotated}/${images.length}`;
        }
    }
}

        // Poll for UI updates
        setInterval(updateUIState, 500);

        // Download classes.txt
        document.getElementById('btnDownloadClasses')?.addEventListener('click', () => {
            if (window.app && window.app.canvasManager.classes.length > 0) {
                const sortedClasses = [...window.app.canvasManager.classes].sort((a, b) => a.id - b.id);
                const classesContent = sortedClasses.map(cls => cls.name).join('\n');

                const blob = new Blob([classesContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'classes.txt';
                a.click();
                URL.revokeObjectURL(url);

                window.app.ui.showToast(window.i18n.t('notifications.classesDownloaded'), 'success');
            } else {
                window.app.ui.showToast(window.i18n.t('notifications.noClasses'), 'warning');
            }
        });

        // Undo button
        document.getElementById('btnUndo')?.addEventListener('click', () => {
            if (window.app) {
                window.app.undo();
            }
        });

        // Clear button
        document.getElementById('btnClear')?.addEventListener('click', () => {
            if (window.app && confirm(window.i18n.t('actions.clearConfirm'))) {
                window.app.canvasManager.annotations = [];
                window.app.canvasManager.redraw();
            }
        });
    </script>
</body>
</html>
